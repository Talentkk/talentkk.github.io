---
title: AGC021F
date: 2022/6/9
description: 　
---

- 现有一个 $N$ 行 $M$ 列的、仅包含黑白格的表格，左上为 $(1, 1)$，右下为 $(N, M)$。
- 对于一个表格，设长度为 $N$ 的数列 $A$，长度为 $M$ 的数列 $B$、$C$ 分别表示：
  - $A_i$ 表示第 $i$ 行第一个黑格的列号。若不存在则为 $M+1$。
  - $B_i$ 表示第 $i$ 列第一个黑格的行号。若不存在则为 $N+1$。
  - $C_i$ 表示第 $i$ 列最后一个黑格的行号。若不存在则为 $0$。
- 现请你求出所有的 $2^{NM}$ 种表格中，不同的数列三元组 $(A,B,C)$ 的个数对 $998244353$ 取模的结果。
- $1 \leq N \leq 8 \times 10^3$，$1 \leq M \leq 200$。

设 $dp(i,j)$ 为考虑一个 $i$ 行 $j$ 列的网格，**其中每行都至少有一个黑色格子**的不同三元组个数。那么计算答案就可以枚举有几行存在黑色格子：
$$
\sum_{i=0}^{n}{\binom n i dp(i,m)}
$$
现在考虑如何计算 $dp(i,j)$ ，我们可以枚举前 $j-1$ 列有 $k$ 行至少存在一个黑色格子，那么：

+ $k=i$ ，那么分两种情况考虑，若第 $j$ 列没有黑色格子，方案数为 $1$ ；若第 $j$ 列存在黑色格子，那么只要 $B_j\leq C_j$ 就一定存在方案，方案数为 $\binom i 2 + i$ ，所以转移为：$dp_{i,j}\leftarrow dp_{i,j-1}\times(\binom i 2 + i + 1)$ 。
+ $k<i$ ，那么第 $j$ 列存在至少 $i-k$ 个黑色格子。对于在前 $j-1$ 列没有出现黑色格子的那些行，我们从小到大依次记为 $p_1,p_2,...,p_{i-k}$ ，同时记 $p_0=B_j-1,p_{i-k+1}=C_j+1$，那么根据定义 $p_0,p_1,...,p_{i-k+1}$ 是单调增加的。同时也容易说明，两个方案不同当且仅当 $p$ 序列不同，而 $p$ 序列的方案数是 $\binom {i+2} {i-k+2}$ ，所以有转移 $dp_{i,j}\leftarrow dp_{k,j-1}\times \binom {i+2} {i-k+2}$ 。

第一个转移可以直接暴力转移，第二个转移可以用 $NTT$ 优化。

时间复杂度 $O(n\times m\times \log n)$ 。

