---
title: AGC021F
date: 2022/6/8
description: 　
---

## CF1528F

给定 $n,k$，求长度为 $n$ 的“好序列” $\{a\}$ 的贡献和。

“好序列”这样定义：对于 $i\in [1,n]$，$\sum [a_j\ge i]\le n- i+1$

其贡献定义为每种颜色的出现次数的 $k$ 次幂之和。

$n\le 10^9,k\le 10^5$

先考虑如何计算有多少个好序列。

将问题进行转化：现在有 $1$ 到 $n$ 恰好 $n$ 个空位排成一排，有 $n$ 个人，每个人从第 $a_i$ 个位置开始向右走，直到找到第一个空位坐下。那么 $a$ 序列合法与每个人都能落座等价。

现在要对转化后的问题计数，这是一个经典的问题，我们可以加上一个空位 $n+1$ ，并将 $1$ 到 $n+1$ 依次连成一个环，现在的每个人就都能落座了。那么先前的“每个人都能落座”就等价于现在的 "$n+1$ 没有被占"。

为了方便，我们把 $a_i$ 的值域扩充到 $[1,n+1]$ （因为反正从 $n+1$ 出发已经不合法了，不影响方案数）。由于现在的问题对于每个位置都是等价的，所以 $n+1$ 不被占的概率是 $\frac{1}{n+1}$ ，那么方案数就是 $(n+1)^{n-1}$ 。

现在考虑计算所有好序列的贡献和，由于最后的问题中每个位置都是等价的，所以我们只需要算出所有**序列**的贡献和再除以 $n+1$ 就是答案。

现在没有“好序列”的限制，计算原序列的贡献和较为简单，对于每一种颜色，它所产生的贡献是：
$$
\sum_{i=0}^{n}{\binom n i \times n^{n-i}\times i^k}
$$
其中：
$$
i^k=\sum_{j=0}^{i}{\operatorname{s}{(k,j)}\times \binom i j\times j!}
$$
带入后交换 $\sum$ 即可快速计算。

时间复杂度 $O(k\times \log k)$ 。