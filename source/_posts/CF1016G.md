---
title: CF1016G
date: 2021/12/8
description: 　
---

给一个长度为 $n$ 的序列 $a$ 和 $x,y$ ，求有多少对 $(i,j)$ 满足存在 $v$ 使得 $\gcd(v,a_i)=x,\operatorname{lcm}(v,a_j)=y$ 。

$1\leq n\leq 2\times 10^5,1\leq x,y,a_i\leq 10^{18}$

首先有 $x|y$ ，这是答案不为 $0$ 的前提条件。其次我们显然只会考虑 $x|a_i$ 的 $a_i$ 和 $a_j|y$ 的 $a_j$ 。

记 $V_p(x)$ 为 $x$ 中质因子 $p$ 的幂次。则对于一个固定的 $p$ ，因为 $x|a_i,a_j|y$ ，有 $V_p(x)\leq V_p(a_i) ,V_p(a_j)\leq V_p(y)$ 。根据题目条件，$v$ 应该满足：$\min(V_p(v),V_p(a_i))=V_p(x),\max(V_p(v),V_p(a_j))=V_p(y)$ 。那么存在合法 $v$ 的条件是：$V_p(a_i)=V_p(x),V_p(a_j)=V_p(y)$ 有至少一个成立。而对于一对 $(i,j)$ ，合法的条件就是对于每个 $y$ 的质因子 $p$ ，均满足上述条件。

由于 $y$ 的质因子个数不超过 $15$ 个，我们先对 $a$ 序列的每个值 $a_i$ 预处两个二进制状态 $mask(i,0),mask(i,1)$ 。$mask(i,0)$ 的第 $j$ 位表示对于 $y$ 的第 $j$ 个质因子 $p$ ，是否存在 $V_p(a_i)\neq v_p(x)$ 。$mask(i,1)$ 的第 $j$ 位表示对于 $y$ 的第 $j$ 个质y因子 $p$ ，是否存在 $V_p(a_i)\neq v_p(y)$ 。则 $(i,j)$ 合法当且仅当 $mask(i,0) \and mask(j,1)=0$ 。我们直接枚举 $mask(i,0)$ 的值，并枚举 $\overline{mask(i,0)}$ 的所有子集，即 $mask(j,1)$ 的值，并计算答案。这样的复杂度是枚举子集的子集的复杂度，$O(3^{15})$ 。

还有一个问题是我们要对 $y$ 进行质因数分解，但 $y$ 是 $10^{18}$ 级别的。我们可以先对 $y$ 除去所有 $10^6$ 内的质因子，假设剩下的值是 $re$ 。若 $re$ 不为 $1$ ，则 $re$ 有三种可能：$re=p^2,re=p\times q,re=p$ ，其中 $p,q$ 是质数。对于第一种是简单的，对于其它情况，我们直接求出 $\gcd(a_i,re)$ ，看是否有一个满足 $\gcd(a_i,re)\neq 1,gcd(a_i,re)\neq re$ ，如果有就找到了 $p$ ，可以分解。如果没有，就把 $re$ 当成一个质数即可，虽然 $re$ 依然可能是两个质数的乘积，但并不影响答案。