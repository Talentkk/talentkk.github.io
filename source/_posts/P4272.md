---
title: P4272
date: 2021/12/21
description: 　
---

## P4272

给一个长度为 $n$ ，值域为 $[1,m]$ 的序列 $a$ ，以及 $l,r$。

你可以进行若干次操作，每次对 $a_i$ 加一或减一，但要时刻保证 $a_i\in[1,m]$ 。

问最少多少次操作，可以满足对任意 $i\in[1,n-1],l\leq a_{i+1}-a_i\leq r$ ，数据保证有解。

$1\leq n\leq500000,1\leq q\leq 10^9$

设 $b_i=a_i-(i-1)\times l$ ，则问题等价于：给定序列 $b$ ，每次可加一减一，并时刻保证 $1\leq b_i\leq m-(i-1)\times l$ ，求最小操作次数使得 $0\leq b_{i+1}-b_{i}\leq r-l$ 。

设 $dp(i,j)$ 表示考虑前 $i$ 个数合法，且最终的 $b_i=j$ 的最小操作次数。转移为：
$$
dp(i,j)=\min_{k=j-(r-l)}^{j}{dp(i-1,k)}+|b_i-j|
$$
容易发现，对于固定的 $i$ ，$j$ 是下凸的，可以使用 `slope trick` 。

具体地，我们用平衡树维护每个斜率改变点的位置，并实时记录最低点的值，以及斜率为 $0$ 的线段的位置。我们把转移看作两步：
$$
dp(i,j)=\min_{k=j-(r-l)}^{j}{dp(i-1,k)}\\
dp(i,j)=dp(i,j)+|b_i-j|
$$
对于第一个转移，对这个下凸函数的变化是：以斜率为 $0$ 的线段为分界线，右边的所有点向右移动 $r-l$ 个单位。

对于第二个转移，直接在平衡树中插入两遍 $b_i$ ，并维护最低点的信息，以及斜率为 $0$ 的线段的位置。注意到每次斜率为 $0$ 的新位置一定是原来位置的前驱或后继，所以可以快速更新。

时间复杂度 $O(n\times \log(n))$ 。