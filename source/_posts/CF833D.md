---
title: CF833D
date: 2022/5/17
description: 　
---

给定一棵 $n$ 个点的树，每条边有权值和黑白两种颜色。求满足黑白边比例在 $[\frac{1}{2},2]$ 的所有路径边权乘积的乘积。

答案对 $10^9+7$ 取模。

$1\leq n\leq 10^5$

由于是较难处理的树上路径问题，所以先点分治。

在分治中心确定时，需要考虑的所有路径都一定是由两条路径拼起来的。假设这两条路径上的黑边白边数量分别为 $(x_0,x_1),(y_0,y_1)$ ，路径来自的子树分别是 $v_1,v_2$，则需要满足：
$$
2(x_0+y_0)\geq x_1+y_1\\
x_0+y_0\leq 2(x_1+y_1)\\
v_1\neq v_2
$$
注意到这里有三个偏序条件，可以用 `cdq分治` 解决。

但是注意到前两个条件具有特殊的性质：两个条件不能同时不满足。这就意味着我们可以用**总方案分别减去不满足两个条件的方案**，转化成了二维偏序，可以用 `BIT` 维护，时间复杂度 $O(n\times \log^2 n)$ 。

