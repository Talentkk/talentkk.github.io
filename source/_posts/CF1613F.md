---
title: CF1613F
date: 2021/12/3
description: 　
---

给一棵 $n$ 个点的树，问存在多少种排列 $p_i$ ，满足不存在一对父子节点 $u,v$ ，$p_u=p_v+1$  。答案对 $998244353$ 取模。

$2\leq n\leq 250000$

考虑容斥，设 $f(x)$ 表示满足至少有 $x$ 对父子节点 $(u,v)$ ，满足 $p_u=p_v+1$ 的方案数。则答案显然等于：
$$
\sum_{i=0}^{n}{(-1)^i f(i)}
$$
对于 $f(x)$ ，显然会有至少 $x$ 个节点，满足它们恰好有一个儿子使得这对父子满足 $p_u=p_v+1$ 。

我们设 $g(x)$ 为在树上选择 $x$ 条边（这些边就代表一对满足条件的父子关系），且没有两条边有相同的父亲的方案数。那么有 $f(x)=g(x)(n-x)!$ ，因为有 $x$ 个点的值都是可以根据其父亲确定的。现在的问题是求出 $g(x)$ 。

这是一个经典问题，$g(i)$ 就是 $\prod_{u} (x+a_u)$ 的 $x^i$ 的系数，其中 $a_u$ 指 $u$ 的儿子个数。若直接对它进行分治+ `NTT` ，时间复杂度 $O(n\times \log(n)^2)$ 。

更聪明的做法是，对于 $a_u$ 分成若干类，假设 $a_u=x$ 的有 $cnt_x$ 个，则式子变成：$\prod_{i}{(x+i)^{cnt_i}}$ ，注意这里 $cnt_i!=0$ 的 $i$ 只有 $\sqrt{n}$ 个。我们先对于每一个 $i$ ，用二项式定理展开，然后再从大到小遍历 $i$ ，用 `NTT` 乘起来。分析下时间复杂度，用二项式定理展开的部分是 $O(n)$ 的，如果我们先不考虑 `NTT` 的 $\log$ 。后面一部分的时间复杂度是：
$$
cnt_n+(cnt_n+cnt_{n-1})+...+(cnt_n+cnt_{n-1}+...+cnt_1)=\sum_{i=1}^{n}{cnt_i}\times i =n-1
$$
所以总时间复杂度是 $O(n\times \log(n))$ 。