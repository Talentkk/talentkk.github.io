---
title: ARC140D
date: 2022/5/17
description: 　
---

对于一个长度为 $n$ 的序列 $X=(X_1,X_2,...,X_n)$ ，定义 $f(X)$ 为：对于一个 $n$ 个点的无向图，$i$ 与 $X_i$ 之间连边后，联通块的数量。现在给出一个 $A$ 序列，其中 $A_i\in[1,n]$ 或 $A_i=-1$ ，你可以把每个 $-1$ 都替换成 $[1,n]$ 中的任意数字，求所有替换方案的 $f(A)$ 的总和对 $10^9+7$ 取模的结果。

$1\leq n\leq 2000$

参照官方题解做法。

对于任意一种方案，得到的图的每个连通块都一定是一棵基环树（点数等于边数），于是我们将问题转化为所有方案下环的数量，同时也等价于对于**每个环出现的次数**求和。

考虑先把 $A_i\neq-1$ 的边连上，则原图会变成若干个连通块，每个连通块都是树或基环树。

根据上面的结论，对于一棵基环树，**无论剩下的边如何连接，这棵基环树上的点都不可能被除基环外的任意环包含**。所以我们只用考虑基环的贡献次数，设 $A$ 中有 $k$ 个 $-1$ ，则答案显然是：$k^n$ 。

于是我们可以不考虑那些基环树，因为它们都不可能在还未计算的环上了。所以现在有若干个树的连通块，假设它们的大小分别为 $b_1,b_2,...,b_l$ 。根据前面的结论可知，对于每棵树，有且仅有一个点满足 $A_u=-1$ 。

考虑枚举一个环，其中的点是由集合 $S$ 这些连通块的点组成，则这样的环的个数显然是：

$$
(|S|-1)!\prod_{i\in S}{b_i}
$$

因为可以把集合 $S$ 中的树排成一圈，并从每棵树固定的点向下一棵树的任意点连一条边。同时对于一个这样的环，它的贡献是 $n^{k-|S|}$ 。

现在你需要计算每个集合的贡献和，可以用 $dp(i,j)$ 表示考虑前 $i$ 棵树，大小为 $j$ 的集合的贡献和计算，时间复杂度 $O(n^2)$ 。