---
title: CF1609F
date: 2021/11/29 
description: 　
---

给出一个长度为 $n$ 的序列 $a$ ，求有多少个区间 $[l,r]$ 满足，区间中的最大值和最小值在二进制下 $1$ 的个数相同。

$1\leq n\leq 10^6,0\leq a_i\leq 10^{18}$

考虑枚举右端点，计算有多少合法的左端点。因为涉及到区间最大值和最小值，所以我们在右端点从左向右移动时，维护后缀 $\min$ 和 $\max$ 的单调栈。我们考虑在 $r\rightarrow r+1$ 的过程中，维护有多少合法的左端点。观察单调栈变化的过程（弹出若干元素，加入一个元素），发现如果我们能够快速查询在区间 $[L,R]$ 中有多少个 $i$ 满足区间 $[i,r]$ 的 $\min$ （或 $\max$）的 $1$ 的个数是 $v$ ，就可以快速维护合法左端点的个数。一种简单的想法是开 $2\times 60$ 棵线段树，前六十棵维护中的第 $x$ 棵维护： $[i,r]$ 的 $\min$ 的 $1$ 的个数等于 $x$ 的有哪些位置，后六十棵类似维护 $\max$ ，时间复杂度 $O(n\times \log(n))$ ，但空间会炸。

于是就考虑平衡一下，只开 $2\times 6$ 棵线段树，跑 $10$ 次维护这个过程。这样时间复杂度会乘 $10$ ，但可以通过。
