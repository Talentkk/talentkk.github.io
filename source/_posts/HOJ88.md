---
title: HOJ88
date: 2021/12/25
description: 　
---

给一个长度为 $n$ 的数组 $a_i$ ，以及一个质数 $p$ ，对任意 $i\in[1,n]$ ，有 $1\leq a_i<p$ 。有以下两种操作：

+ 给 $[l,r]$ 区间乘上 $x$ 
+ 计算区间 $[l,r]$ 中所有 $a_i$ 所组成的集合在模 $p$ 乘法群下生成子群大小。

$n,q\leq 10^5,2\leq p\leq 10^9$

下面的运算都是在模 $p$ 意义下。

设 $p$ 的原根是 $g$ ，$a_i=g^{b_i}$ 。则对于区间 $[l,r]$ 的答案，相当于：$b_lx_l+b_{l+1}x_{l+1}+...+b_rx_{r}$ 在模 $p-1$ 的意义下解的个数，根据裴蜀定理，解的个数为 $\gcd(b_l,b_{l+1},...,b_r,p-1)$ 。

于是问题就转换为了区间加法，区间求 $\gcd$ ，这是一个经典问题。考虑 $b_i$ 的差分数组 $c_i=b_i-b_{i-1}$ ，有：
$$
\gcd(b_l,b_{l+1},...,b_{r})=\gcd(b_l,c_{l+1},...,c_{r})
$$
由于区间加对于差分数组 $c$ 的修改是单点的，可以用一棵线段树维护。

注意每次修改操作都要先使用 `BSGS` 解出区间加的值，再插入到线段树中。这种实现方式的通过难度较大。

注意到我们关心的值是 $\gcd(b_l,b_{l+1},...,b_r,p-1)$ ，它是 $p-1$ 的因子。考虑对 $p-1$ 进行质因数分解，得到 $p-1=i_1^{j_1}\times i_2^{j_2}\times...$ ，只要我们对于每一个质因子 $i_k$ 求出它在 $\gcd$ 中的幂次，就可获得答案。

一个重要的观察是：对于任意 $x$ ，$b_i \bmod x=0$ 的充分必要条件是 $a_i^{\frac{p-1}{x}}=1$ 。

则我们可以对于每一个质因子的每一个次幂分别开一颗线段树维护（最多 $\log$ 棵），维护的信息是：是否区间 $[l,r]$ 中的所有 $i$ 满足$a_i^{\frac{p-1}{x}}=1$ 。这样我们对于每一个质因子的每一个幂次，都可以快速判断其是否是 $gcd$ 的因子。修改操作则变成了区间乘法，时间复杂度 $O(n\times \log(n)^2)$ 。