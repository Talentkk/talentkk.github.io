---
title: CF1620F
date: 2021/12/22
description: 　
---

称一个长度为 $n$ 的数组 $a$ 合法，当且仅当满足以下条件：

1. 对所有 $i<j$ ，若有 $a_i>a_j$ ，从 $i$ 向 $j$ 连无向边。
2. 得到的图是二分图。

现在给出一个排列 $p_i$ ，问是否存在一个大小为 $n$ 的数组 $a$ ，满足 $a_i=p_i$ 或 $a_i=-p_i$ ，使得 $a$ 是合法的。

$1\leq n\leq 10^6$

容易发现 $a$ 合法当且仅当：不存在长度为 $3$ 的下降子序列。

为了计算这个问题，我们考虑设 $dp(i,j,k)$ 表示：考虑前 $i$ 个数，**最大的**长度为 $1$ 的下降子序列结尾为 $j$ （其实就是前 $i$ 个数中的最大值），**最大的**长度为 $2$ 的下降子序列结尾为 $k$ ，是否合法。容易得到必然有 $j>k$ ，转移时分三种情况讨论：

+ $j>k>a_{i+1}$ ，存在长度为 $3$ 的下降子序列，不合法。
+ $j>a_{i+1}>k$ ，$dp(i,j,k)\to dp(i+1,j,a_{i+1})$
+ $a_{i+1}>j>k$ ，$dp(i,j,k)\to dp(i+1,a_{i+1},k)$

有两个重要的观察是：

+ 对于固定的 $i,j$ ，我们只关心最小的 $k$ 使得 $dp(i,j,k)=1$ ，对于固定的 $i,k$ ，我们只关心最小的 $j$ 使得 $dp(i,j,k)=1$ 。
+ 对于 $dp(i,j,k)=1$ 的状态，$j=a_{i+1}$ 和 $k=a_{i+1}$ 中至少有一个成立。

于是我们调整 $dp$ 状态，设 $dp(i,x=0/1,y=0/1)$ 表示：

+ $x=0$ ：考虑前 $i$ 个数，$j=a_{i}$ ，$a_i=p_i$ 还是 $a_i=-p_i$（$y=0/1$）时，最小的 $k$ 满足 $dp(i,j,k)=1$ 。
+ $x=1$ ：考虑前 $i$ 个数，$k=a_{i}$ ，$a_i=p_i$ 还是 $a_i=-p_i$（$y=0/1$）时，最小的 $j$ 满足 $dp(i,j,k)=1$ 。

转移与前面的对应即可，时间复杂度 $O(n)$ 。